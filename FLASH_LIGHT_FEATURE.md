# 闪光灯功能说明 - 暗光环境扫描增强

## 功能概述

为了提高在暗光环境下的扫描准确性，我们为扫描组件添加了完整的闪光灯控制功能。

## 主要功能

### 1. ✅ 自动检测闪光灯支持
- 启动摄像头时自动检测设备是否支持闪光灯
- 支持多种闪光灯控制方式：
  - **torch API**（手电筒模式）- 最常用
  - **fillLightMode**（填充光模式）
  - **exposureCompensation**（曝光补偿）- 间接提高亮度

### 2. 💡 手动控制闪光灯
- 点击"ライトオン/ライトオフ"按钮手动开启/关闭闪光灯
- 闪光灯开启时按钮会有视觉反馈（黄色高亮 + 脉冲动画）
- 实时状态提示

### 3. 🌙 智能低光环境检测
- **自动检测环境亮度**：每2秒分析一次视频帧的亮度
- **智能提示**：检测到暗光环境时自动提示用户开启闪光灯
- **一键开启**：提示框中可直接点击开启闪光灯

### 4. 🎨 视觉反馈
- 闪光灯按钮开启时有动画效果
- 低光环境提示有优雅的动画和渐变背景
- 状态消息实时更新

## 使用方法

### 基本使用

1. **启动扫描**
   - 进入"高级扫描"页面
   - 系统自动检测设备是否支持闪光灯
   - 如果支持，会显示"ライトオン"按钮

2. **手动开启闪光灯**
   - 点击"ライトオン"按钮
   - 闪光灯会立即开启
   - 按钮变为黄色并显示"ライトオフ"

3. **自动提示（暗光环境）**
   - 如果检测到环境较暗
   - 会自动显示蓝色提示框
   - 可以直接点击"ライトをオン"按钮开启

### 技术细节

#### 亮度检测算法
```javascript
// 使用标准灰度公式计算亮度
brightness = (r * 0.299 + g * 0.587 + b * 0.114)
// 阈值：80（0-255范围）
// 低于阈值 = 低光环境
```

#### 支持的API
1. **torch API**（优先）
   ```javascript
   track.applyConstraints({
     advanced: [{ torch: true }]
   })
   ```

2. **fillLightMode**
   ```javascript
   track.applyConstraints({
     advanced: [{ fillLightMode: 'flash' }]
   })
   ```

3. **exposureCompensation**
   ```javascript
   track.applyConstraints({
     advanced: [{ exposureCompensation: 2.0 }]
   })
   ```

## 设备兼容性

### ✅ 完全支持
- **iOS Safari**：支持 torch API
- **Android Chrome**：支持 torch API 和 fillLightMode
- **现代移动设备**：大部分支持

### ⚠️ 部分支持
- **桌面浏览器**：通常不支持硬件闪光灯
- **旧设备**：可能不支持 torch API

### ❌ 不支持
- **没有闪光灯的设备**：无法使用此功能
- **某些桌面摄像头**：不支持硬件控制

## 性能优化

1. **亮度检测频率**：每2秒检测一次，避免过度消耗资源
2. **自动清理**：停止扫描时自动停止亮度检测
3. **错误处理**：完善的错误处理和降级方案

## 用户体验改进

### 视觉反馈
- ✅ 闪光灯按钮开启时有脉冲动画
- ✅ 低光提示有优雅的渐变动画
- ✅ 状态消息实时更新

### 智能提示
- ✅ 自动检测暗光环境
- ✅ 友好的提示信息
- ✅ 一键开启功能

## 故障排除

### 问题1：看不到闪光灯按钮
**原因**：设备不支持闪光灯控制  
**解决**：这是正常的，某些设备（如桌面摄像头）不支持硬件闪光灯

### 问题2：点击按钮没有反应
**原因**：可能是API不支持或权限问题  
**解决**：
1. 检查浏览器控制台是否有错误
2. 尝试重新启动扫描
3. 某些设备可能需要重新获取摄像头流

### 问题3：低光检测不准确
**原因**：阈值可能需要调整  
**解决**：可以在代码中调整 `threshold` 值（默认80）

## 未来改进方向

1. **自动开启**：检测到低光时自动开启闪光灯（可选）
2. **亮度调节**：支持调节闪光灯亮度
3. **更多设备支持**：扩展更多设备的兼容性
4. **用户偏好**：记住用户的闪光灯偏好设置

## 代码位置

- 组件文件：`dynamic-label-front/src/components/AdvancedScanner.vue`
- 主要函数：
  - `checkFlashSupport()` - 检测闪光灯支持
  - `toggleFlash()` - 切换闪光灯
  - `detectLightLevel()` - 检测环境亮度
  - `startLightDetection()` - 开始亮度检测

## 总结

✅ **已实现**：
- 自动检测闪光灯支持
- 手动控制闪光灯
- 智能低光环境检测
- 友好的用户界面

🎯 **效果**：
- 在暗光环境下扫描准确性显著提高
- 用户体验更加友好
- 支持多种设备和浏览器




